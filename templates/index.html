<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d1117; 
            color: #e2e8f0; 
            display: flex;
        }
        body::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1e1b4b, #312e81, #0d1117, #0d1117); background-size: 400% 400%; animation: gradient-animation 25s ease infinite; z-index: -1; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .glass-ui { background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        footer.glass-ui { border-bottom: none; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: transparent; }
        #chat-messages::-webkit-scrollbar-thumb { background: rgba(129, 140, 248, 0.5); border-radius: 3px; }

        .chat-container { opacity: 0; animation: fadeIn 0.8s 0.2s forwards cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { to { opacity: 1; } }
        .message-wrapper { opacity: 0; transform: translateY(15px) scale(0.98); animation: popIn 0.5s forwards cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes popIn { to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .typing-indicator { display: flex; align-items: flex-end; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #818cf8; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator span:nth-child(3) { animation-delay: -0.32s; }
        @keyframes bounce-anim { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* --- NEW: Styles for the Vertical Suggestion List --- */
        #suggestions-popup { 
            position: absolute; 
            bottom: calc(100% + 10px); /* Position above the footer */
            left: 0; 
            right: 0; 
            background: rgba(30, 41, 59, 0.8); /* Dark background */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 12px; 
            box-shadow: 0 -10px 30px -5px rgba(0,0,0,0.2); 
            padding: 8px; 
            margin: 0 1rem; 
            opacity: 0; 
            transform: translateY(10px); 
            transition: all 0.3s ease; 
            pointer-events: none; 
            max-height: 250px;
            overflow-y: auto;
        }
        #suggestions-popup.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #suggestions-popup::-webkit-scrollbar { width: 4px; }
        #suggestions-popup::-webkit-scrollbar-thumb { background: rgba(129, 140, 248, 0.4); border-radius: 2px; }

        .suggestion-item { 
            display: flex; align-items: center; width: 100%; text-align: left; 
            padding: 10px 12px; border-radius: 8px; 
            color: #cbd5e1; font-weight: 500; cursor: pointer; 
            transition: background-color 0.2s ease, color 0.2s ease; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0; transform: translateY(10px); animation: slideInUp 0.4s forwards;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: rgba(79, 70, 229, 0.3); color: #fff; }
        .suggestion-item svg { margin-right: 10px; flex-shrink: 0; color: #a5b4fc; }

        .suggestion-loader { 
            display: flex; align-items: center; justify-content: center; padding: 16px; 
            color: #94a3b8; font-style: italic; font-size: 0.9rem;
        }
        .suggestion-loader div { width: 6px; height: 6px; background-color: #94a3b8; border-radius: 50%; margin: 0 3px; animation: bounce-anim 1.4s infinite ease-in-out both; }
        .suggestion-loader .bounce1 { animation-delay: -0.32s; }
        .suggestion-loader .bounce2 { animation-delay: -0.16s; }
        
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Unchanged styles below --- */
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(8px); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #loading-overlay.visible { display: flex; opacity: 1; }
        .progress-bar-container { width: 80%; max-width: 320px; height: 6px; background-color: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 1.5rem; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #4f46e5, #a78bfa); transition: width 0.5s ease-in-out; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <p id="loading-text" class="text-lg font-semibold text-slate-200">Processing...</p>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </div>

    <div class="w-full h-full flex flex-col chat-container">
        
        <header class="p-4 flex items-center justify-between flex-shrink-0 z-10 glass-ui">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-bold text-xl shadow-lg ring-2 ring-white/20">J</div>
                <div class="ml-4">
                    <h1 class="text-lg font-bold text-slate-100">Jarvis Assistant</h1>
                    <p id="status-text" class="text-sm text-indigo-300 flex items-center">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-2 shadow-[0_0_8px_#4ade80]"></span>Online
                    </p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/history" target="_blank" class="text-slate-400 hover:text-white transition-colors text-sm font-semibold">History</a>
                <a href="/logs" target="_blank" class="text-slate-400 hover:text-white transition-colors text-sm font-semibold">Logs</a>
                <button id="refresh-button" title="Refresh Knowledge Base" class="refresh-button text-slate-400 hover:text-white hover:rotate-180 p-2 rounded-full transition-all duration-500 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>
            </div>
        </header>

        <main id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-6"></main>
        
        <footer class="p-4 relative flex-shrink-0 glass-ui">
            <!-- NEW: The suggestion container is now a pop-up -->
            <div id="suggestions-popup"></div>

            <div class="flex items-start space-x-3">
                <textarea id="message-input" class="flex-1 p-3 bg-slate-800/70 text-slate-200 border border-slate-600 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all placeholder-slate-500" placeholder="Ask anything..." rows="1"></textarea>
                <button id="send-button" class="send-button text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg bg-gradient-to-br from-indigo-500 to-purple-600 transition-all duration-200 ease-in-out transform hover:scale-110 disabled:from-slate-500 disabled:to-slate-600 disabled:cursor-not-allowed disabled:transform-none active:scale-95">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        // MODIFIED: suggestionsContainer is now suggestionsPopup
        const suggestionsPopup = document.getElementById('suggestions-popup');
        
        // --- Other variables are unchanged ---
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusText = document.getElementById('status-text').childNodes[2]; 
        const refreshButton = document.getElementById('refresh-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        
        const serverUrl = ""; 
        let debounceTimer;

        // --- Most JavaScript is unchanged ---
        function addMessage(content, isBot = false) { /* ... same as before ... */ }
        async function sendMessage(message) { /* ... same as before ... */ }
        function handleInput() { /* ... same as before ... */ }
        async function fetchSuggestions(keyword) { /* ... same as before ... */ }
        async function refreshKnowledgeBase() { /* ... same as before ... */ }
        function scrollToBottom() { /* ... same as before ... */ }
        function autoResizeTextarea() { /* ... same as before ... */ }
        
        // --- MODIFIED: Functions to handle the new suggestion UI ---
        function showSuggestionLoader() {
            suggestionsPopup.innerHTML = `
                <div class="suggestion-loader">
                    <span>Generating suggestions</span>
                    <div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div>
                </div>
            `;
            suggestionsPopup.classList.add('active');
        }

        function hideSuggestions() {
            suggestionsPopup.classList.remove('active');
        }

        function displaySuggestions(questions) {
            suggestionsPopup.innerHTML = ''; // Clear previous content
            if (!questions || questions.length === 0) {
                hideSuggestions();
                return;
            }
            
            questions.forEach((q, index) => {
                const item = document.createElement('button');
                item.className = 'suggestion-item';
                item.style.animationDelay = `${index * 80}ms`; 
                item.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    <span>${q}</span>
                `;
                item.onclick = () => {
                    messageInput.value = q;
                    hideSuggestions();
                    sendMessage(q);
                };
                suggestionsPopup.appendChild(item);
            });

            if (!suggestionsPopup.classList.contains('active')) {
                 suggestionsPopup.classList.add('active');
            }
        }

        // --- Event Listeners and Initialization ---
        sendButton.addEventListener('click', () => sendMessage(messageInput.value));
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(messageInput.value); } });
        messageInput.addEventListener('input', () => {
            autoResizeTextarea();
            clearTimeout(debounceTimer);
            if (messageInput.value.trim().length < 3) {
                hideSuggestions();
                return;
            }
            debounceTimer = setTimeout(() => {
                showSuggestionLoader();
                fetchSuggestions(messageInput.value.trim());
            }, 700);
        });
        refreshButton.addEventListener('click', refreshKnowledgeBase);
        // Hide suggestions if user clicks outside
        document.addEventListener('click', (e) => { 
            if (!document.querySelector('footer').contains(e.target)) {
                hideSuggestions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', async () => { /* ... same as before ... */ });

        // --- FULL JAVASCRIPT FUNCTIONS (PASTED FOR COMPLETENESS) ---
        function addMessage(content, isBot = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper flex w-full ${isBot ? 'justify-start' : 'justify-end'}`;
            const bubble = document.createElement('div');
            let bubbleClasses = 'max-w-md lg:max-w-lg p-3.5 rounded-2xl shadow-lg text-base leading-relaxed ';
            if (isBot) {
                bubbleClasses += 'bg-slate-700/50 backdrop-blur-sm border border-white/10 text-slate-200 rounded-bl-lg';
            } else {
                bubbleClasses += 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-br-lg';
            }
            bubble.className = bubbleClasses;
            bubble.innerHTML = content.replace(/\n/g, '<br>');
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
            return bubble;
        }

        async function sendMessage(message) {
            const userMessage = message.trim();
            if (!userMessage) return;
            hideSuggestions();
            addMessage(userMessage, false);
            messageInput.value = '';
            autoResizeTextarea();
            const botBubble = addMessage('<div class="typing-indicator"><span></span><span></span><span></span></div>', true);
            try {
                const response = await fetch(`${serverUrl}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: userMessage })
                });
                if (!response.ok) throw new Error('Network response was not ok.');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                botBubble.innerHTML = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    fullResponse += decoder.decode(value, { stream: true });
                    botBubble.innerHTML = fullResponse.replace(/\n/g, '<br>');
                    scrollToBottom();
                }
            } catch (error) {
                botBubble.innerHTML = "Sorry, connection failed. Please check the server and try again.";
            }
        }

        async function fetchSuggestions(keyword) {
            try {
                const response = await fetch(`${serverUrl}/suggest_questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword: keyword })
                });
                if (!response.ok) throw new Error('Suggestion fetch failed');
                const data = await response.json();
                const validQuestions = data.questions && data.questions.filter(q => q && q.trim().length > 10);
                displaySuggestions(validQuestions);
            } catch (error) {
                console.error("Suggestion Error:", error);
                hideSuggestions();
            }
        }
        
        async function refreshKnowledgeBase() {
            if (refreshButton.classList.contains('loading')) return;
            loadingOverlay.classList.add('visible');
            refreshButton.classList.add('loading', 'animate-spin');
            try {
                const response = await fetch(`${serverUrl}/refresh_index`, { method: 'POST' });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to start refresh.');
                }
                const data = await response.json();
                addMessage(`<em class="text-indigo-300">System: ${data.message}</em>`, true);
                let statusInterval = setInterval(async () => {
                    const statusResponse = await fetch('/refresh_status');
                    const statusData = await statusResponse.json();
                    loadingText.textContent = statusData.message;
                    progressBar.style.width = `${statusData.progress}%`;
                    if (!statusData.is_running) {
                        clearInterval(statusInterval);
                        setTimeout(() => {
                            loadingOverlay.classList.remove('visible');
                            refreshButton.classList.remove('loading', 'animate-spin');
                            addMessage(`<em class="text-indigo-300">System: Knowledge base refreshed.</em>`, true);
                        }, 500);
                    }
                }, 1500);
            } catch (error) {
                loadingOverlay.classList.remove('visible');
                refreshButton.classList.remove('loading', 'animate-spin');
                addMessage(`<em class="text-red-400">System Error: ${error.message}</em>`, true);
            }
        }
        
        function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 200);
            messageInput.style.height = `${newHeight}px`;
            messageInput.style.overflowY = newHeight >= 200 ? 'auto' : 'hidden';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            autoResizeTextarea();
            try {
                const response = await fetch(`${serverUrl}/get_initial_data`);
                if (!response.ok) throw new Error('Failed to fetch initial data');
                const data = await response.json();
                addMessage(`<strong>${data.greeting}, ${data.username}!</strong> Welcome to Jarvis. How can I assist you with the provided documents?`, true);
            } catch (e) {
                addMessage("<strong>Hello!</strong> Could not connect to the server. Please ensure it's running and refresh.", true);
            }
        });
    </script>
</body>
</html>

